# 项目架构设计

## 整体架构

### 分层架构设计
采用伪3层架构模式：

```
┌─────────────────────────────────────────────────────────┐
│                  API Layer (Controller)                │
│            FastAPI路由 + 中间件处理                   │
├─────────────────────────────────────────────────────────┤
│                 Service Layer (Business)                │
│              业务逻辑处理 + 权限控制                      │
├─────────────────────────────────────────────────────────┤
│                 Data Layer (Persistence)               │
│            SQLAlchemy ORM + 数据库连接                    │
└─────────────────────────────────────────────────────────┘
```

### 核心模块

#### 1. API 层 (app/api/)
- **路由定义**：按功能模块组织路由
- **请求处理**：参数解析、验证
- **响应格式化**：统一的响应格式
- **中间件**：认证、日志、限流

#### 2. Service 层 (app/services/)
- **业务逻辑**：核心业务处理
- **权限控制**：RBAC + 数据权限
- **事务管理**：数据库事务处理
- **缓存管理**：Redis 缓存策略

#### 3. Model 层 (app/models/)
- **数据模型**：SQLAlchemy 模型定义
- **关系映射**：表关系定义
- **审计字段**：创建时间、更新时间等
- **软删除**：逻辑删除支持

#### 4. Schema 层 (app/schemas/)
- **请求模式**：请求数据验证
- **响应模式**：响应数据格式化
- **数据库模式**：数据库操作模式
- **类型转换**：数据类型映射

## 插件化架构

### 插件系统设计
```
app/
├── plugins/
│   ├── core.py              # 插件核心管理
│   ├── interface.py          # 插件接口定义
│   ├── registry.py          # 插件注册中心
│   └── [plugin_name]/      # 具体插件实现
│       ├── __init__.py
│       ├── config.py
│       ├── models.py
│       ├── api.py
│       └── services.py
```

### 插件特性
- **动态加载**：运行时加载/卸载插件
- **配置管理**：独立配置文件
- **依赖管理**：插件间依赖关系
- **生命周期**：初始化、启动、停止、销毁

## 安全架构

### 认证授权
1. **JWT 认证**
   - Access Token + Refresh Token
   - Token 黑名单（Redis）
   - 自动过期和刷新

2. **RBAC 权限模型**
   ```
   User → Role → Permission
               ↓
           Menu (UI权限)
           API (接口权限)
   ```

3. **数据权限**
   - 全部数据权限
   - 部门数据权限
   - 个人数据权限
   - 自定义数据权限

### 安全中间件
- **CORS**：跨域请求控制
- **限流**：API 调用频率限制
- **IP 白名单**：访问控制
- **SQL 注入防护**：ORM 层面防护

## 数据架构

### 多数据库支持
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   MySQL     │  │ PostgreSQL  │  │  MongoDB    │
│  (主数据库)   │  │(GIS+Vector) │  │  (文档存储)   │
└─────────────┘  └─────────────┘  └─────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│    Redis    │  │Elasticsearch│  │   Milvus    │
│ (缓存/Session)│  │ (全文搜索)   │  │ (向量检索)   │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 数据同步策略
- **主从复制**：读写分离
- **数据分片**：水平扩展
- **缓存策略**：多级缓存
- **搜索索引**：实时同步

## 部署架构

### 单体部署
```
┌─────────────────────────────────────────────┐
│              Load Balancer               │
│              (Nginx/HAProxy)              │
└─────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────┐
│            FastAPI Application           │
│            (Gunicorn + Uvicorn)           │
└─────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────┐
│            Database Cluster               │
│         MySQL + PostgreSQL + Redis         │
└─────────────────────────────────────────────┘
```

### 微服务部署
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  API Gateway│  │ Auth Service│  │ System Svc  │
│   (Kong)    │  │             │  │             │
└─────────────┘  └─────────────┘  └─────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ File Service│  │  AI Service │  │ Job Service  │
│             │  │             │  │             │
└─────────────┘  └─────────────┘  └─────────────┘
```

## 监控架构

### 可观测性
1. **指标监控**：Prometheus + Grafana
2. **日志聚合**：Loguru + Loki
3. **链路追踪**：OpenTelemetry
4. **健康检查**：服务健康状态

### 告警体系
- **指标告警**：CPU、内存、磁盘、网络
- **业务告警**：错误率、响应时间
- **安全告警**：异常访问、SQL注入
- **通知渠道**：邮件、短信、钉钉、企业微信