# S3 兼容开源文件系统部署指南

> 数据根目录: `/Volumes/T7/programe/env/docker`
>
> 配置文件: `scripts/docker-compose-file.yml`

## 快速开始

```bash
# 进入 scripts 目录
cd scripts

# 启动单个服务
docker-compose -f docker-compose-file.yml up -d <service_name>

# 停止服务
docker-compose -f docker-compose-file.yml stop <service_name>

# 查看日志
docker-compose -f docker-compose-file.yml logs -f <service_name>
```

---

## 开源 S3 兼容文件系统对比

### 综合对比表

| 系统 | 语言 | S3 兼容性 | 适用场景 | 资源占用 | 分布式 | 活跃度 |
|------|------|----------|----------|----------|--------|--------|
| **MinIO** | Go | 完整 | 通用对象存储 | 中 | 支持 | 非常活跃 |
| **SeaweedFS** | Go | 较好 | 海量小文件 | 低 | 支持 | 活跃 |
| **Garage** | Rust | 较好 | 自托管/边缘 | 极低 | 支持 | 活跃 |
| **Ceph RGW** | C++ | 完整 | 企业级大规模 | 高 | 支持 | 非常活跃 |
| **OpenIO** | C/Python | 较好 | 企业级 | 中 | 支持 | 活跃 |
| **Zenko CloudServer** | Node.js | 完整 | 混合云网关 | 中 | 支持 | 中等 |
| **LocalStack** | Python | 完整 | 开发测试 | 中 | 不支持 | 非常活跃 |
| **LakeFS** | Go | 较好 | 数据湖版本控制 | 中 | 支持 | 活跃 |
| **S3Mock** | Java | 基础 | 单元测试 | 低 | 不支持 | 中等 |

### 详细特性对比

| 特性 | MinIO | SeaweedFS | Garage | Ceph | LocalStack |
|------|-------|-----------|--------|------|------------|
| **S3 API 完整度** | 99% | 85% | 80% | 95% | 95% |
| **版本控制** | 支持 | 支持 | 支持 | 支持 | 支持 |
| **生命周期策略** | 支持 | 部分 | 不支持 | 支持 | 支持 |
| **多部分上传** | 支持 | 支持 | 支持 | 支持 | 支持 |
| **服务端加密** | 支持 | 支持 | 支持 | 支持 | 支持 |
| **存储桶策略** | 支持 | 部分 | 部分 | 支持 | 支持 |
| **复制** | 支持 | 支持 | 支持 | 支持 | 不支持 |
| **纠删码** | 支持 | 支持 | 不支持 | 支持 | 不支持 |
| **Web UI** | 支持 | 支持 | 不支持 | 支持 | 不支持 |
| **Kubernetes 部署** | 官方支持 | 支持 | 支持 | 支持 | 支持 |

### 性能对比 (参考值)

| 系统 | 读吞吐量 | 写吞吐量 | 小文件性能 | 大文件性能 |
|------|----------|----------|------------|------------|
| **MinIO** | 高 | 高 | 中 | 高 |
| **SeaweedFS** | 高 | 高 | 极高 | 中 |
| **Garage** | 中 | 中 | 中 | 中 |
| **Ceph** | 高 | 高 | 中 | 高 |
| **LocalStack** | 低 | 低 | 低 | 低 |

---

## 选型建议

### 按场景选择

| 场景 | 推荐方案 | 原因 |
|------|----------|------|
| **生产环境通用** | MinIO | 成熟稳定、完整S3兼容、活跃社区 |
| **海量小文件** | SeaweedFS | 针对小文件优化、高吞吐 |
| **本地开发测试** | LocalStack / S3Mock | 轻量、快速启动 |
| **个人自托管** | Garage | 极轻量、易部署 |
| **企业大规模** | Ceph / MinIO | 企业级特性、高可用 |
| **数据湖/ML** | LakeFS + MinIO | 版本控制、可回滚 |
| **混合云** | Zenko CloudServer | 多云支持 |

### 按团队规模选择

| 团队规模 | 推荐方案 |
|----------|----------|
| 个人开发者 | MinIO 单节点 / Garage |
| 小团队 (< 10人) | MinIO 单节点 |
| 中型团队 (10-50人) | MinIO 分布式 |
| 大型企业 (> 50人) | MinIO / Ceph |

---

## 各系统部署详解

### 1. MinIO

**最推荐的通用方案**

```bash
# 启动单节点
docker-compose -f docker-compose-file.yml up -d minio

# 启动分布式 (4节点)
docker-compose -f docker-compose-file.yml up -d minio-distributed-1 minio-distributed-2 minio-distributed-3 minio-distributed-4
```

| 配置项 | 单节点 | 分布式 |
|--------|--------|--------|
| Console | http://127.0.0.1:9001 | http://127.0.0.1:9003 |
| API | http://127.0.0.1:9002 | http://127.0.0.1:9004 |
| Access Key | minioadmin | minioadmin |
| Secret Key | minioadmin123 | minioadmin123 |
| 数据目录 | `/Volumes/T7/programe/env/docker/minio/data` | `/Volumes/T7/programe/env/docker/minio-distributed/` |

**Python 连接示例:**
```python
# pip install minio
from minio import Minio

client = Minio(
    "127.0.0.1:9002",
    access_key="minioadmin",
    secret_key="minioadmin123",
    secure=False
)

# 创建 bucket
client.make_bucket("my-bucket")

# 上传文件
client.fput_object("my-bucket", "test.txt", "/path/to/local/file.txt")

# 下载文件
client.fget_object("my-bucket", "test.txt", "/path/to/download/file.txt")

# 生成预签名 URL
url = client.presigned_get_object("my-bucket", "test.txt", expires=timedelta(hours=1))
```

**使用 boto3 (AWS SDK):**
```python
# pip install boto3
import boto3

s3 = boto3.client(
    's3',
    endpoint_url='http://127.0.0.1:9002',
    aws_access_key_id='minioadmin',
    aws_secret_access_key='minioadmin123'
)

# 创建 bucket
s3.create_bucket(Bucket='my-bucket')

# 上传文件
s3.upload_file('/path/to/file.txt', 'my-bucket', 'test.txt')

# 下载文件
s3.download_file('my-bucket', 'test.txt', '/path/to/download.txt')

# 列出对象
response = s3.list_objects_v2(Bucket='my-bucket')
for obj in response.get('Contents', []):
    print(obj['Key'])
```

---

### 2. SeaweedFS

**适合海量小文件场景**

```bash
# 启动完整套件 (Master + Volume + Filer + S3)
docker-compose -f docker-compose-file.yml up -d seaweedfs-master seaweedfs-volume seaweedfs-filer seaweedfs-s3
```

| 组件 | 端口 | 说明 |
|------|------|------|
| Master | 9333 | 管理元数据 |
| Volume | 8080 | 存储数据 |
| Filer | 8888 | 文件系统接口 |
| S3 | 8333 | S3 API |

**创建 S3 配置文件** (`/Volumes/T7/programe/env/docker/seaweedfs/s3/s3.json`):
```json
{
  "identities": [
    {
      "name": "admin",
      "credentials": [
        {
          "accessKey": "admin",
          "secretKey": "admin123"
        }
      ],
      "actions": ["Admin", "Read", "Write", "List", "Tagging"]
    }
  ]
}
```

**Python 连接示例:**
```python
import boto3

s3 = boto3.client(
    's3',
    endpoint_url='http://127.0.0.1:8333',
    aws_access_key_id='admin',
    aws_secret_access_key='admin123'
)

# 创建 bucket
s3.create_bucket(Bucket='my-bucket')
```

---

### 3. Garage

**轻量级自托管方案**

```bash
docker-compose -f docker-compose-file.yml up -d garage
```

**创建配置文件** (`/Volumes/T7/programe/env/docker/garage/garage.toml`):
```toml
metadata_dir = "/var/lib/garage/meta"
data_dir = "/var/lib/garage/data"
db_engine = "lmdb"

replication_mode = "none"

rpc_bind_addr = "[::]:3901"
rpc_public_addr = "127.0.0.1:3901"
rpc_secret = "your-secret-key-here"

[s3_api]
s3_region = "garage"
api_bind_addr = "[::]:3900"
root_domain = ".s3.garage.localhost"

[s3_web]
bind_addr = "[::]:3902"
root_domain = ".web.garage.localhost"

[admin]
api_bind_addr = "[::]:3903"
admin_token = "admin-token-here"
```

| 配置项 | 值 |
|--------|------|
| S3 API | http://127.0.0.1:3900 |
| Admin API | http://127.0.0.1:3901 |
| Web | http://127.0.0.1:3902 |

**初始化配置:**
```bash
# 进入容器
docker exec -it fba_garage /bin/sh

# 查看节点 ID
garage node id

# 配置布局
garage layout assign -z dc1 -c 1 <NODE_ID>
garage layout apply --version 1

# 创建密钥
garage key create my-key

# 创建 bucket
garage bucket create my-bucket
garage bucket allow my-bucket --read --write --key my-key
```

---

### 4. LocalStack (开发测试)

**最适合本地开发和 CI/CD**

```bash
docker-compose -f docker-compose-file.yml up -d localstack
```

| 配置项 | 值 |
|--------|------|
| Endpoint | http://127.0.0.1:4566 |
| Region | us-east-1 |
| Access Key | test (任意值) |
| Secret Key | test (任意值) |
| 数据目录 | `/Volumes/T7/programe/env/docker/localstack/data` |

**Python 连接示例:**
```python
import boto3

s3 = boto3.client(
    's3',
    endpoint_url='http://127.0.0.1:4566',
    aws_access_key_id='test',
    aws_secret_access_key='test',
    region_name='us-east-1'
)

# LocalStack 免费版可用
s3.create_bucket(Bucket='my-bucket')
s3.put_object(Bucket='my-bucket', Key='test.txt', Body='Hello World')
```

**awscli 使用:**
```bash
# 配置 endpoint
aws --endpoint-url=http://127.0.0.1:4566 s3 ls
aws --endpoint-url=http://127.0.0.1:4566 s3 mb s3://my-bucket
aws --endpoint-url=http://127.0.0.1:4566 s3 cp test.txt s3://my-bucket/
```

---

### 5. Zenko CloudServer

**S3 API 网关，支持多后端**

```bash
docker-compose -f docker-compose-file.yml up -d cloudserver
```

| 配置项 | 值 |
|--------|------|
| Endpoint | http://127.0.0.1:8000 |
| Access Key | accesskey |
| Secret Key | secretkey |
| 数据目录 | `/Volumes/T7/programe/env/docker/cloudserver/data` |

**Python 连接示例:**
```python
import boto3

s3 = boto3.client(
    's3',
    endpoint_url='http://127.0.0.1:8000',
    aws_access_key_id='accesskey',
    aws_secret_access_key='secretkey'
)
```

---

### 6. LakeFS

**数据湖版本控制**

```bash
docker-compose -f docker-compose-file.yml up -d lakefs
```

| 配置项 | 值 |
|--------|------|
| Web UI | http://127.0.0.1:8001 |
| S3 Gateway | http://127.0.0.1:8001 |
| 数据目录 | `/Volumes/T7/programe/env/docker/lakefs/data` |

**首次访问:** 打开 http://127.0.0.1:8001 完成初始设置，获取 Access Key 和 Secret Key。

**Python 连接示例:**
```python
# pip install lakefs-client
import lakefs_client
from lakefs_client import models
from lakefs_client.client import LakeFSClient

configuration = lakefs_client.Configuration(
    host='http://127.0.0.1:8001',
    username='<access_key>',
    password='<secret_key>'
)

client = LakeFSClient(configuration)

# 创建仓库
client.repositories.create_repository(
    models.RepositoryCreation(
        name='my-repo',
        storage_namespace='local://my-repo',
        default_branch='main'
    )
)
```

---

### 7. S3Mock (单元测试)

**最轻量的 S3 模拟器**

```bash
docker-compose -f docker-compose-file.yml up -d s3mock
```

| 配置项 | 值 |
|--------|------|
| HTTP | http://127.0.0.1:9090 |
| HTTPS | https://127.0.0.1:9191 |
| 初始 Bucket | test-bucket |

**Python 连接示例:**
```python
import boto3

s3 = boto3.client(
    's3',
    endpoint_url='http://127.0.0.1:9090',
    aws_access_key_id='foo',
    aws_secret_access_key='bar'
)
```

---

### 8. Ceph (企业级)

**大规模企业存储**

```bash
# 注意: Ceph 需要较多资源
docker-compose -f docker-compose-file.yml up -d ceph-demo
```

| 配置项 | 值 |
|--------|------|
| S3 (RGW) | http://127.0.0.1:8080 |
| Dashboard | http://127.0.0.1:5000 |
| Access Key | accesskey |
| Secret Key | secretkey |
| 初始 Bucket | demo |

---

## 云盘/文件同步系统

### FileBrowser

**简单的 Web 文件管理器**

```bash
docker-compose -f docker-compose-file.yml up -d filebrowser
```

**创建配置文件** (`/Volumes/T7/programe/env/docker/filebrowser/config.json`):
```json
{
  "port": 80,
  "baseURL": "",
  "address": "",
  "log": "stdout",
  "database": "/database.db",
  "root": "/srv"
}
```

| 配置项 | 值 |
|--------|------|
| 访问地址 | http://127.0.0.1:8089 |
| 默认用户 | admin |
| 默认密码 | admin |

---

### Nextcloud

**功能丰富的云盘平台**

```bash
docker-compose -f docker-compose-file.yml up -d nextcloud-mysql nextcloud
```

| 配置项 | 值 |
|--------|------|
| 访问地址 | http://127.0.0.1:8090 |
| 管理员 | admin |
| 密码 | admin123 |

---

### Seafile

**企业级文件同步**

```bash
docker-compose -f docker-compose-file.yml up -d seafile-mysql seafile-memcached seafile
```

| 配置项 | 值 |
|--------|------|
| 访问地址 | http://127.0.0.1:8091 |
| 管理员 | admin@seafile.local |
| 密码 | admin123 |

---

## 端口一览表

| 服务 | 端口 | 用途 |
|------|------|------|
| MinIO | 9001/9002 | Console/API |
| MinIO 分布式 | 9003/9004 | Console/API |
| SeaweedFS Master | 9333 | 管理 |
| SeaweedFS Volume | 8080 | 存储 |
| SeaweedFS Filer | 8888 | 文件系统 |
| SeaweedFS S3 | 8333 | S3 API |
| Garage | 3900/3901/3902 | S3/Admin/Web |
| CloudServer | 8000 | S3 API |
| LocalStack | 4566 | AWS 模拟 |
| LakeFS | 8001 | Web/S3 |
| S3Mock | 9090/9191 | HTTP/HTTPS |
| Ceph | 8080/5000 | S3/Dashboard |
| OpenIO | 6007 | S3 API |
| FileBrowser | 8089 | Web |
| Nextcloud | 8090 | Web |
| Seafile | 8091 | Web |

---

## 通用 Python 客户端封装

```python
"""
S3 兼容存储通用客户端
支持: MinIO, SeaweedFS, Garage, LocalStack, Zenko 等
"""
from typing import Optional, BinaryIO
from datetime import timedelta
import boto3
from botocore.config import Config

class S3Client:
    """S3 兼容存储客户端"""

    def __init__(
        self,
        endpoint_url: str,
        access_key: str,
        secret_key: str,
        region: str = "us-east-1",
        secure: bool = False
    ):
        self.client = boto3.client(
            's3',
            endpoint_url=endpoint_url,
            aws_access_key_id=access_key,
            aws_secret_access_key=secret_key,
            region_name=region,
            config=Config(signature_version='s3v4')
        )

    def create_bucket(self, bucket: str) -> None:
        """创建存储桶"""
        self.client.create_bucket(Bucket=bucket)

    def delete_bucket(self, bucket: str) -> None:
        """删除存储桶"""
        self.client.delete_bucket(Bucket=bucket)

    def list_buckets(self) -> list:
        """列出所有存储桶"""
        response = self.client.list_buckets()
        return [b['Name'] for b in response['Buckets']]

    def upload_file(self, bucket: str, key: str, file_path: str) -> None:
        """上传文件"""
        self.client.upload_file(file_path, bucket, key)

    def upload_fileobj(self, bucket: str, key: str, fileobj: BinaryIO) -> None:
        """上传文件对象"""
        self.client.upload_fileobj(fileobj, bucket, key)

    def download_file(self, bucket: str, key: str, file_path: str) -> None:
        """下载文件"""
        self.client.download_file(bucket, key, file_path)

    def delete_object(self, bucket: str, key: str) -> None:
        """删除对象"""
        self.client.delete_object(Bucket=bucket, Key=key)

    def list_objects(self, bucket: str, prefix: str = "") -> list:
        """列出对象"""
        response = self.client.list_objects_v2(Bucket=bucket, Prefix=prefix)
        return [obj['Key'] for obj in response.get('Contents', [])]

    def get_presigned_url(
        self,
        bucket: str,
        key: str,
        expires: int = 3600,
        method: str = "get_object"
    ) -> str:
        """生成预签名 URL"""
        return self.client.generate_presigned_url(
            method,
            Params={'Bucket': bucket, 'Key': key},
            ExpiresIn=expires
        )


# 使用示例
if __name__ == "__main__":
    # MinIO
    minio_client = S3Client(
        endpoint_url="http://127.0.0.1:9002",
        access_key="minioadmin",
        secret_key="minioadmin123"
    )

    # LocalStack
    localstack_client = S3Client(
        endpoint_url="http://127.0.0.1:4566",
        access_key="test",
        secret_key="test"
    )

    # SeaweedFS
    seaweedfs_client = S3Client(
        endpoint_url="http://127.0.0.1:8333",
        access_key="admin",
        secret_key="admin123"
    )
```

---

## 常见问题

### Q: 如何选择合适的存储系统?

**生产环境:** MinIO (推荐) 或 Ceph (大规模)
**开发测试:** LocalStack 或 S3Mock
**海量小文件:** SeaweedFS
**个人使用:** Garage 或 MinIO 单节点

### Q: 如何迁移数据?

使用 `mc` (MinIO Client) 或 `rclone`:
```bash
# 使用 mc
mc alias set src http://127.0.0.1:9002 minioadmin minioadmin123
mc alias set dst http://new-server:9002 minioadmin minioadmin123
mc mirror src/bucket dst/bucket

# 使用 rclone
rclone sync source:bucket dest:bucket
```

### Q: 如何备份数据?

```bash
# MinIO 快照
mc mirror minio/bucket /backup/bucket

# 或使用 rsync 备份数据目录
rsync -avz /Volumes/T7/programe/env/docker/minio/data /backup/
```
