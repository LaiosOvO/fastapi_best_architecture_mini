# 雪花算法 (Snowflake Algorithm) 技术文档

## 1. 概述

雪花算法（Snowflake）是 Twitter 开源的一种分布式 ID 生成算法，能够生成全局唯一的 64 位整数 ID。该算法生成的 ID 具有趋势递增的特点，适用于分布式系统中的唯一标识需求。

## 2. 算法原理

雪花算法生成的 64 位 ID 结构如下：

```
符号位(1位) + 时间戳(41位) + 数据中心ID(5位) + 工作机器ID(5位) + 序列号(12位)
```

### 2.1 位结构详解

- **符号位 (1 bit)**: 固定为 0，保证 ID 为正整数
- **时间戳 (41 bits)**: 记录自自定义纪元时间以来的毫秒数，可使用约 69 年
- **数据中心ID (5 bits)**: 支持最多 32 个数据中心 (0-31)
- **工作机器ID (5 bits)**: 每个数据中心支持最多 32 台机器 (0-31)  
- **序列号 (12 bits)**: 每毫秒支持最多 4096 个 ID (0-4095)

### 2.2 配置参数

```python
WORKER_ID_BITS = 5        # 工作机器ID位数
DATACENTER_ID_BITS = 5    # 数据中心ID位数  
SEQUENCE_BITS = 12        # 序列号位数

MAX_WORKER_ID = 31        # 最大工作机器ID
MAX_DATACENTER_ID = 31    # 最大数据中心ID
SEQUENCE_MASK = 4095      # 序列号掩码
```

## 3. 实现特点

### 3.1 全局唯一性
- 通过时间戳、数据中心ID、机器ID和序列号的组合确保全局唯一
- 在同一毫秒内通过序列号递增保证唯一性

### 3.2 趋势递增性
- 时间戳部分保证整体趋势递增
- 有利于数据库索引性能

### 3.3 高性能
- 单机 QPS 可达 10万+
- 使用内存操作，无网络开销

## 4. 系统架构

### 4.1 节点管理
- 支持固定配置和 Redis 动态分配两种模式
- Redis 用于节点 ID 的分配和心跳维护
- 防止多实例冲突

### 4.2 时钟回拨处理
- 支持 10 秒内的时钟回拨容忍
- 超出容忍范围时抛出异常
- 确保 ID 唯一性

## 5. 配置选项

### 5.1 固定配置模式
```python
# 通过环境变量配置
SNOWFLAKE_DATACENTER_ID = 1  # 数据中心ID
SNOWFLAKE_WORKER_ID = 1      # 工作机器ID
```

### 5.2 动态分配模式
- 通过 Redis 自动分配可用的节点 ID
- 支持水平扩展
- 自动心跳维护节点有效性

## 6. 使用方法

### 6.1 初始化
```python
from backend.utils.snowflake import snowflake

await snowflake.init()
```

### 6.2 生成 ID
```python
id = snowflake.generate()
```

### 6.3 解析 ID
```python
from backend.utils.snowflake import snowflake

info = snowflake.parse(id)
print(f"时间戳: {info.timestamp}")
print(f"日期时间: {info.datetime}")
print(f"数据中心ID: {info.datacenter_id}")
print(f"工作机器ID: {info.worker_id}")
print(f"序列号: {info.sequence}")
```

## 7. 性能指标

- **吞吐量**: 单机可达 10万 QPS
- **延迟**: 纳秒级操作
- **并发**: 支持多线程安全访问
- **容量**: 每毫秒最多 4096 个 ID

## 8. 优势与适用场景

### 8.1 优势
- 全局唯一，无冲突
- 趋势递增，利于索引
- 高性能，低延迟
- 分布式部署友好
- 无单点故障风险

### 8.2 适用场景
- 分布式系统唯一标识
- 数据库主键生成
- 订单号生成
- 日志追踪ID
- 缓存键生成

## 9. 数据结构

### 9.1 SnowflakeInfo 数据类

雪花算法解析功能返回 `SnowflakeInfo` 数据类，包含 ID 的详细组成信息：

```python
@dataclasses.dataclass
class SnowflakeInfo:
    timestamp: int      # 时间戳（毫秒）
    datetime: str       # 格式化日期时间字符串
    datacenter_id: int  # 数据中心ID
    worker_id: int      # 工作机器ID
    sequence: int       # 序列号
```

#### 字段说明：

- **timestamp**: 从自定义纪元时间（2010-01-01）开始的毫秒数
- **datetime**: 可读的日期时间格式字符串
- **datacenter_id**: 5位数据中心标识符 (0-31)
- **worker_id**: 5位工作机器标识符 (0-31)
- **sequence**: 12位序列号 (0-4095)

#### 使用示例：

```python
from backend.utils.snowflake import snowflake

# 生成雪花ID
snowflake_id = snowflake.generate()

# 解析ID获取详细信息
info = snowflake.parse(snowflake_id)

print(f"生成时间: {info.datetime}")
print(f"数据中心: {info.datacenter_id}")
print(f"工作机器: {info.worker_id}")
print(f"序列号: {info.sequence}")
```

## 10. 注意事项

- 需要确保系统时间准确
- 时钟回拨可能导致服务暂停
- 合理规划数据中心和机器ID
- 监控 Redis 连接状态